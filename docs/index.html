<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Argument & Critiques</title>
  <style>
    body {
      display: flex;
      gap: 20px;
      padding: 20px;
      font-family: sans-serif;
    }
    .column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .panel {
      display: flex;
      border: 1px solid #ccc;
      padding: 10px;
      gap: 20px;
    }
    .argument, .critiques {
      width: 300px;
      overflow-y: auto;
      max-height: 200px;
      padding: 5px;
      border: 1px solid #eee;
    }
    .highlight {
      background-color: yellow;
    }
    .user-highlight {
      background-color: orange;
    }
    .critique-item:hover {
      background-color: #ffeaa7;
      cursor: pointer;
    }
    .submit-box {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    textarea {
      width: 100%;
      height: 50px;
    }
  </style>
</head>
<body>
  <script>
    const backendURL = "https://deliberator-app.onrender.com";
    let currentHighlight = null;

    async function fetchData(endpoint) {
      try {
        const res = await fetch(`${backendURL}${endpoint}`);
        if (!res.ok) throw new Error("Failed to fetch");
        return await res.json();
      } catch (err) {
        console.error("Fetch error:", err);
        return null;
      }
    }

    function renderData(data) {
      if (!Array.isArray(data)) {
        console.error("Invalid data format:", data);
        return;
      }

      data.forEach(col => {
        const columnEl = document.createElement('div');
        columnEl.className = 'column';

        col.forEach(panelData => {
          if (!panelData.argument || !Array.isArray(panelData.critiques)) {
            console.warn("Skipping malformed panelData:", panelData);
            return;
          }

          const panel = document.createElement('div');
          panel.className = 'panel';

          const argDiv = document.createElement('div');
          argDiv.className = 'argument';
          const rawArg = panelData.argument;

          const spanMap = {};
          for (let i = 0; i < rawArg.length; i++) {
            const span = document.createElement('span');
            span.textContent = rawArg[i];
            span.dataset.index = i;
            argDiv.appendChild(span);
            spanMap[i] = span;
          }

          const critDiv = document.createElement('div');
          critDiv.className = 'critiques';

          panelData.critiques.forEach(([text, start, end], idx) => {
            const item = document.createElement('div');
            item.className = 'critique-item';
            item.textContent = text;

            item.addEventListener('mouseenter', () => {
              for (let i = start; i < end; i++) {
                spanMap[i]?.classList.add('highlight');
              }
            });

            item.addEventListener('mouseleave', () => {
              for (let i = start; i < end; i++) {
                spanMap[i]?.classList.remove('highlight');
              }
            });

            critDiv.appendChild(item);
          });

          Object.keys(spanMap).forEach(i => {
            const span = spanMap[i];
            span.addEventListener('mouseenter', () => {
              panelData.critiques.forEach(([text, start, end], idx) => {
                if (i >= start && i < end) {
                  critDiv.children[idx]?.classList.add('highlight');
                }
              });
            });
            span.addEventListener('mouseleave', () => {
              panelData.critiques.forEach(([text, start, end], idx) => {
                if (i >= start && i < end) {
                  critDiv.children[idx]?.classList.remove('highlight');
                }
              });
            });
          });

          // Submission UI
          const submitBox = document.createElement('div');
          submitBox.className = 'submit-box';

          const textarea = document.createElement('textarea');
          const submitBtn = document.createElement('button');
          submitBtn.textContent = 'Submit Critique';

          let selectedRange = null;

          argDiv.addEventListener('mouseup', () => {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            const range = selection.getRangeAt(0);
            if (!argDiv.contains(range.commonAncestorContainer)) return;

            Object.values(spanMap).forEach(span => span.classList.remove('user-highlight'));

            let start = parseInt(range.startContainer.dataset.index || range.startContainer.parentElement?.dataset.index);
            let end = parseInt(range.endContainer.dataset.index || range.endContainer.parentElement?.dataset.index) + 1;

            if (isNaN(start) || isNaN(end) || start >= end) {
              selectedRange = null;
              return;
            }

            for (let i = start; i < end; i++) {
              spanMap[i]?.classList.add('user-highlight');
            }

            currentHighlight = { start, end };
            selectedRange = { start, end };
          });

          submitBtn.addEventListener('click', async () => {
            const critique = textarea.value.trim();
            if (!selectedRange || critique === "") {
              alert("Please highlight some text in an argument and enter a critique before submitting.");
              return;
            }

            const payload = {
              argument_text: rawArg,
              critique,
              start: selectedRange.start,
              end: selectedRange.end
            };

            try {
              const res = await fetch(`${backendURL}/submit`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
              });

              if (!res.ok) {
                throw new Error("Failed to submit");
              }

              // Add to display without reload
              panelData.critiques.push([critique, selectedRange.start, selectedRange.end]);

              const item = document.createElement('div');
              item.className = 'critique-item';
              item.textContent = critique;
              item.addEventListener('mouseenter', () => {
                for (let i = selectedRange.start; i < selectedRange.end; i++) {
                  spanMap[i]?.classList.add('highlight');
                }
              });
              item.addEventListener('mouseleave', () => {
                for (let i = selectedRange.start; i < selectedRange.end; i++) {
                  spanMap[i]?.classList.remove('highlight');
                }
              });
              critDiv.appendChild(item);

              textarea.value = "";
              Object.values(spanMap).forEach(span => span.classList.remove('user-highlight'));
              currentHighlight = null;
              selectedRange = null;
            } catch (err) {
              console.error("Error submitting critique:", err);
              alert("Submission failed.");
            }
          });

          submitBox.appendChild(textarea);
          submitBox.appendChild(submitBtn);

          const wrapper = document.createElement('div');
          wrapper.style.display = "flex";
          wrapper.style.flexDirection = "column";
          wrapper.appendChild(argDiv);
          wrapper.appendChild(submitBox);

          panel.appendChild(wrapper);
          panel.appendChild(critDiv);
          columnEl.appendChild(panel);
        });

        document.body.appendChild(columnEl);
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      fetchData("/data").then(data => {
        if (data) renderData(data);
      });
    });
  </script>
</body>
</html>
