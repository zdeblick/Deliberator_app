async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const createAccount = document.getElementById('createAccount').checked;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password || null,
                        create_account: createAccount
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    currentUser = username;
                    
                    // Hide login screen and show main app
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('userInfo').style.display = 'block<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arguments and Critiques</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .columns {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .column {
            min-width: 400px;
            background-color: #e8e8e8;
            border-radius: 8px;
            padding: 15px;
        }

        .column-header {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background-color: #d0d0d0;
            border-radius: 5px;
        }

        .panel {
            background-color: white;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            min-height: 200px;
        }

        .argument-section {
            flex: 1;
            border-right: 2px solid #eee;
            padding-right: 15px;
        }

        .argument-text {
            line-height: 1.6;
            cursor: default;
        }

        .critiques-section {
            flex: 1;
            padding-left: 15px;
        }

        .critiques-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #fafafa;
        }

        .critique {
            margin-bottom: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border-left: 3px solid #007acc;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .critique:hover {
            background-color: #e6f3ff;
            border-left-color: #0056b3;
            box-shadow: 0 2px 8px rgba(0,122,204,0.3);
        }

        .highlighted-text {
            background-color: #fff3cd;
            border-radius: 2px;
            padding: 1px 2px;
            transition: all 0.2s ease;
        }

        .highlighted-text:hover {
            background-color: #ffeaa7;
            box-shadow: 0 0 8px rgba(255,193,7,0.6);
        }

        .highlighted-text.glow {
            background-color: #ffeaa7;
            box-shadow: 0 0 8px rgba(255,193,7,0.6);
        }

        .critique.glow {
            background-color: #e6f3ff;
            border-left-color: #0056b3;
            box-shadow: 0 2px 8px rgba(0,122,204,0.3);
        }

        .controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .btn {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .critique-modal .modal-content {
            display: flex;
            gap: 20px;
        }

        .critique-form-section {
            flex: 1;
        }

        .argument-preview-section {
            flex: 1;
            border-left: 2px solid #ddd;
            padding-left: 20px;
        }

        .argument-preview {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            line-height: 1.6;
        }

        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .login-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .user-info {
            position: fixed;
            top: 15px;
            left: 15px;
            background-color: #007acc;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 1000;
        }

        .rating-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .rating-label {
            font-weight: bold;
            text-align: right;
            padding-right: 10px;
        }

        .rating-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rating-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .rating-option input[type="radio"] {
            margin-bottom: 5px;
        }

        .rating-option label {
            font-size: 11px;
            text-align: center;
            line-height: 1.2;
        }

        .statement-preview {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }

        .modal-header {
            font-weight: bold;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            text-align: right;
            margin-top: 20px;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: black;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007acc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-message {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .loading-submessage {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .selection-info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-content">
            <h2 style="margin-bottom: 20px;">Welcome to Arguments and Critiques</h2>
            <div id="loginError"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label for="password">Password (optional for new accounts):</label>
                    <input type="password" id="password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="createAccount"> Create new account
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn">Login / Sign Up</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Info Display -->
    <div id="userInfo" class="user-info" style="display: none;">
        Logged in as: <span id="currentUser"></span>
    </div>

    <div class="container">
        <h1 style="text-align: center; margin-bottom: 10px; color: #333;">Arguments and Critiques</h1>
        <div style="text-align: center; margin-bottom: 20px; color: #666; font-size: 12px;">Version 2.0</div>
        
        <div class="controls">
            <button class="btn" onclick="showArgumentModal()">Add Argument</button>
            <button class="btn" onclick="showCritiqueModal()">Add Critique</button>
            <button class="btn" onclick="showRatingModal()">Rate Statement</button>
        </div>

        <div class="columns" id="columns">
            <!-- Columns will be dynamically populated -->
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-message" id="loadingMessage">Connecting to server...</div>
            <div class="loading-submessage" id="loadingSubmessage">This may take a moment</div>
        </div>
    </div>

    <!-- Add Argument Modal -->
    <div id="argumentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('argumentModal')">&times;</span>
            <div class="modal-header">Add New Argument</div>
            <div id="argumentError"></div>
            <form onsubmit="submitArgument(event)">
                <div class="form-group">
                    <label for="argumentColumn">Column:</label>
                    <select id="argumentColumn" required>
                        <!-- Options populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="argumentText">Argument:</label>
                    <textarea id="argumentText" placeholder="Enter your argument..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('argumentModal')" style="background-color: #6c757d;">Cancel</button>
                    <button type="submit" class="btn">Add Argument</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Critique Modal -->
    <div id="critiqueModal" class="modal critique-modal">
        <div class="modal-content">
            <div class="critique-form-section">
                <span class="close" onclick="closeCritiqueModal()">&times;</span>
                <div class="modal-header">Add New Critique</div>
                <div id="critiqueError"></div>
                <div id="selectionInfo" class="selection-info" style="display: none;"></div>
                <form onsubmit="submitCritique(event)">
                    <div class="form-group">
                        <label for="critiqueText">Critique:</label>
                        <textarea id="critiqueText" placeholder="Enter your critique..." required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeCritiqueModal()" style="background-color: #6c757d;">Cancel</button>
                        <button type="submit" class="btn">Add Critique</button>
                    </div>
                </form>
            </div>
            <div class="argument-preview-section">
                <div class="modal-header">Argument Being Critiqued</div>
                <div id="argumentPreview" class="argument-preview">
                    Select text from an argument first.
                </div>
            </div>
        </div>
    </div>

    <!-- Rate Statement Modal -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRatingModal()">&times;</span>
            <div class="modal-header">Rate Statement</div>
            <div id="ratingError"></div>
            <div id="statementPreview" class="statement-preview" style="display: none;"></div>
            <form onsubmit="submitRating(event)">
                <div class="rating-grid">
                    <div class="rating-label">This statement is written:</div>
                    <div class="rating-options">
                        <div class="rating-option">
                            <input type="radio" name="quality" value="1" id="quality1" required>
                            <label for="quality1">Very Poorly</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="quality" value="2" id="quality2">
                            <label for="quality2">Poorly</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="quality" value="3" id="quality3">
                            <label for="quality3">Not Well</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="quality" value="4" id="quality4">
                            <label for="quality4">Intelligibly</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="quality" value="5" id="quality5">
                            <label for="quality5">Adequately</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="quality" value="6" id="quality6">
                            <label for="quality6">Well</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="quality" value="7" id="quality7">
                            <label for="quality7">Very Well</label>
                        </div>
                    </div>
                    
                    <div class="rating-label">With this statement, I:</div>
                    <div class="rating-options">
                        <div class="rating-option">
                            <input type="radio" name="agreement" value="1" id="agreement1" required>
                            <label for="agreement1">Strongly Disagree</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="agreement" value="2" id="agreement2">
                            <label for="agreement2">Disagree</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="agreement" value="3" id="agreement3">
                            <label for="agreement3">Somewhat Disagree</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="agreement" value="4" id="agreement4">
                            <label for="agreement4">am Neutral</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="agreement" value="5" id="agreement5">
                            <label for="agreement5">Somewhat Agree</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="agreement" value="6" id="agreement6">
                            <label for="agreement6">Agree</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="agreement" value="7" id="agreement7">
                            <label for="agreement7">Strongly Agree</label>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeRatingModal()" style="background-color: #6c757d;">Cancel</button>
                    <button type="submit" class="btn">Submit Rating</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'https://deliberator-app.onrender.com';
        let data = [];
        let selectedText = null;
        let currentUser = null;
        let selectedStatement = null; // For rating functionality

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show login screen first
            document.getElementById('loginContainer').style.display = 'flex';
        });

        async function loadData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingSubmessage = document.getElementById('loadingSubmessage');
            const statusMessage = document.getElementById('statusMessage');
            
            // Show loading overlay
            loadingOverlay.style.display = 'flex';
            statusMessage.style.display = 'none';
            
            const startTime = Date.now();
            let coldStartWarningShown = false;
            
            // Show cold start warning after 3 seconds
            const coldStartTimer = setTimeout(() => {
                if (!coldStartWarningShown) {
                    loadingMessage.textContent = 'Backend is starting up...';
                    loadingSubmessage.textContent = 'Render services can take up to 50 seconds to wake up from sleep. Please be patient!';
                    coldStartWarningShown = true;
                }
            }, 3000);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                
                const response = await fetch(`${API_BASE}/data`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                clearTimeout(coldStartTimer);
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                data = await response.json();
                loadingOverlay.style.display = 'none';
                
                // Show success message if it was a slow load
                const loadTime = Date.now() - startTime;
                if (loadTime > 5000) {
                    statusMessage.className = 'status-message status-warning';
                    statusMessage.textContent = `Connected successfully! (took ${Math.round(loadTime/1000)} seconds)`;
                    statusMessage.style.display = 'block';
                    
                    // Hide success message after 5 seconds
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 5000);
                }
                
                renderColumns();
                
            } catch (error) {
                clearTimeout(coldStartTimer);
                loadingOverlay.style.display = 'none';
                
                console.error('Error loading data:', error);
                
                let errorMessage = 'Unable to connect to the server. ';
                
                if (error.name === 'AbortError') {
                    errorMessage += 'The request timed out after 60 seconds. The server may be experiencing issues.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'Please check that the backend is running and accessible.';
                } else {
                    errorMessage += error.message;
                }
                
                statusMessage.className = 'status-message status-error';
                statusMessage.innerHTML = `
                    ${errorMessage}
                    <br><br>
                    <button class="btn" onclick="loadData()" style="margin-top: 10px;">Try Again</button>
                `;
                statusMessage.style.display = 'block';
            }
        }

        function renderColumns() {
            const columnsContainer = document.getElementById('columns');
            columnsContainer.innerHTML = '';

            data.forEach((column, columnIndex) => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'column';
                
                const header = document.createElement('div');
                header.className = 'column-header';
                header.textContent = `Column ${columnIndex + 1}`;
                columnDiv.appendChild(header);

                column.forEach((panel, panelIndex) => {
                    const panelDiv = document.createElement('div');
                    panelDiv.className = 'panel';
                    panelDiv.dataset.columnIndex = columnIndex;
                    panelDiv.dataset.panelIndex = panelIndex;

                    // Argument section
                    const argumentSection = document.createElement('div');
                    argumentSection.className = 'argument-section';
                    
                    const argumentText = document.createElement('div');
                    argumentText.className = 'argument-text';
                    argumentText.innerHTML = createHighlightedText(panel.argument, panel.critiques, columnIndex, panelIndex);
                    argumentSection.appendChild(argumentText);

                    // Critiques section
                    const critiquesSection = document.createElement('div');
                    critiquesSection.className = 'critiques-section';
                    
                    const critiquesContainer = document.createElement('div');
                    critiquesContainer.className = 'critiques-container';
                    
                    if (panel.critiques.length === 0) {
                        critiquesContainer.innerHTML = '<em>No critiques yet</em>';
                    } else {
                        panel.critiques.forEach((critique, critiqueIndex) => {
                            const critiqueDiv = document.createElement('div');
                            critiqueDiv.className = 'critique';
                            critiqueDiv.textContent = critique[0];
                            critiqueDiv.dataset.columnIndex = columnIndex;
                            critiqueDiv.dataset.panelIndex = panelIndex;
                            critiqueDiv.dataset.critiqueIndex = critiqueIndex;
                            critiqueDiv.addEventListener('mouseenter', highlightCorrespondingText);
                            critiqueDiv.addEventListener('mouseleave', removeHighlight);
                            critiquesContainer.appendChild(critiqueDiv);
                        });
                    }
                    
                    critiquesSection.appendChild(critiquesContainer);

                    panelDiv.appendChild(argumentSection);
                    panelDiv.appendChild(critiquesSection);
                    columnDiv.appendChild(panelDiv);
                });

                columnsContainer.appendChild(columnDiv);
            });

            // Populate column options in modals
            populateColumnOptions();
        }

        function createHighlightedText(text, critiques, columnIndex, panelIndex) {
            if (critiques.length === 0) return text;

            // Sort critiques by start index
            const sortedCritiques = [...critiques].sort((a, b) => a[1] - b[1]);
            
            let result = '';
            let lastIndex = 0;

            sortedCritiques.forEach((critique, critiqueIndex) => {
                const [, start, end] = critique;
                
                // Add text before highlight
                result += text.slice(lastIndex, start);
                
                // Add highlighted text
                const highlightedSpan = `<span class="highlighted-text" data-column-index="${columnIndex}" data-panel-index="${panelIndex}" data-critique-index="${critiqueIndex}">${text.slice(start, end)}</span>`;
                result += highlightedSpan;
                
                lastIndex = end;
            });

            // Add remaining text
            result += text.slice(lastIndex);

            return result;
        }

        function highlightCorrespondingText(event) {
            const critiqueElement = event.target;
            const columnIndex = critiqueElement.dataset.columnIndex;
            const panelIndex = critiqueElement.dataset.panelIndex;
            const critiqueIndex = critiqueElement.dataset.critiqueIndex;

            // Add glow to critique
            critiqueElement.classList.add('glow');

            // Find and highlight corresponding text
            const textSpan = document.querySelector(
                `.highlighted-text[data-column-index="${columnIndex}"][data-panel-index="${panelIndex}"][data-critique-index="${critiqueIndex}"]`
            );
            if (textSpan) {
                textSpan.classList.add('glow');
            }
        }

        function removeHighlight(event) {
            const critiqueElement = event.target;
            const columnIndex = critiqueElement.dataset.columnIndex;
            const panelIndex = critiqueElement.dataset.panelIndex;
            const critiqueIndex = critiqueElement.dataset.critiqueIndex;

            // Remove glow from critique
            critiqueElement.classList.remove('glow');

            // Remove highlight from corresponding text
            const textSpan = document.querySelector(
                `.highlighted-text[data-column-index="${columnIndex}"][data-panel-index="${panelIndex}"][data-critique-index="${critiqueIndex}"]`
            );
            if (textSpan) {
                textSpan.classList.remove('glow');
            }
        }

        // Add event listeners for text highlighting
        document.addEventListener('mouseup', function(e) {
            // Small delay to ensure selection is complete
            setTimeout(handleTextSelection, 10);
        });

        function handleTextSelection() {
            console.log('=== Text Selection Debug ===');
            const selection = window.getSelection();
            
            if (selection.rangeCount === 0) {
                console.log('No ranges in selection');
                // Don't clear selectedText here - keep the last valid selection
                return;
            }
            
            const selectedString = selection.toString().trim();
            console.log('Selected string:', `"${selectedString}"`);
            
            if (selectedString === '') {
                console.log('Empty selection');
                // Don't clear selectedText here - keep the last valid selection
                return;
            }

            // Find which panel this selection belongs to
            const range = selection.getRangeAt(0);
            console.log('Selection range:', range);
            
            // Get all panels and check which one contains the selection
            const panels = document.querySelectorAll('.panel');
            let targetPanel = null;
            let targetColumnIndex = -1;
            let targetPanelIndex = -1;
            
            for (let panel of panels) {
                const argumentSection = panel.querySelector('.argument-section');
                if (argumentSection) {
                    // Check if the selection is within this argument section
                    try {
                        if (argumentSection.contains(range.startContainer) || 
                            argumentSection.contains(range.endContainer) ||
                            range.intersectsNode(argumentSection)) {
                            targetPanel = panel;
                            targetColumnIndex = parseInt(panel.dataset.columnIndex);
                            targetPanelIndex = parseInt(panel.dataset.panelIndex);
                            console.log('Found target panel:', targetColumnIndex, targetPanelIndex);
                            break;
                        }
                    } catch (e) {
                        console.log('Error checking panel:', e);
                        continue;
                    }
                }
            }
            
            if (!targetPanel || targetColumnIndex === -1 || targetPanelIndex === -1) {
                console.log('Could not find target panel');
                // Don't clear selectedText here - might be selecting outside argument area
                return;
            }
            
            // Get the original text
            if (!data[targetColumnIndex] || !data[targetColumnIndex][targetPanelIndex]) {
                console.log('Invalid data indices');
                return;
            }
            
            const originalText = data[targetColumnIndex][targetPanelIndex].argument;
            console.log('Original text:', originalText);
            
            // Find the position in original text
            // Method 1: Exact match
            let startIndex = originalText.indexOf(selectedString);
            if (startIndex !== -1) {
                console.log('Found exact match at position:', startIndex);
                selectedText = {
                    columnIndex: targetColumnIndex,
                    panelIndex: targetPanelIndex,
                    text: selectedString,
                    startIndex: startIndex,
                    endIndex: startIndex + selectedString.length
                };
                console.log('Selection successful:', selectedText);
                
                // Visual feedback - highlight the selected text briefly
                showSelectionFeedback();
                return;
            }
            
            // Method 2: Handle multiple occurrences by finding the best match
            let allMatches = [];
            let searchStart = 0;
            while (true) {
                let matchIndex = originalText.indexOf(selectedString, searchStart);
                if (matchIndex === -1) break;
                allMatches.push(matchIndex);
                searchStart = matchIndex + 1;
            }
            
            console.log('All matches found:', allMatches);
            
            if (allMatches.length > 0) {
                // For now, just use the first match
                // TODO: Could improve this by analyzing selection position
                startIndex = allMatches[0];
                selectedText = {
                    columnIndex: targetColumnIndex,
                    panelIndex: targetPanelIndex,
                    text: selectedString,
                    startIndex: startIndex,
                    endIndex: startIndex + selectedString.length
                };
                console.log('Using first match:', selectedText);
                showSelectionFeedback();
                return;
            }
            
            // Method 3: Normalize whitespace and try again
            const normalizedSelected = selectedString.replace(/\s+/g, ' ');
            const normalizedOriginal = originalText.replace(/\s+/g, ' ');
            
            let normalizedIndex = normalizedOriginal.indexOf(normalizedSelected);
            if (normalizedIndex !== -1) {
                console.log('Found match after normalizing whitespace');
                
                // Map back to original positions
                let originalIndex = 0;
                let normalizedCount = 0;
                
                while (normalizedCount < normalizedIndex && originalIndex < originalText.length) {
                    if (originalText[originalIndex].match(/\s/)) {
                        // Skip consecutive whitespace in original
                        while (originalIndex < originalText.length && originalText[originalIndex].match(/\s/)) {
                            originalIndex++;
                        }
                        if (normalizedCount < normalizedOriginal.length && normalizedOriginal[normalizedCount] === ' ') {
                            normalizedCount++;
                        }
                    } else {
                        originalIndex++;
                        normalizedCount++;
                    }
                }
                
                startIndex = originalIndex;
                
                // Find end position
                let remainingChars = normalizedSelected.length;
                while (remainingChars > 0 && originalIndex < originalText.length) {
                    if (originalText[originalIndex].match(/\s/)) {
                        originalIndex++;
                        if (remainingChars > 0 && normalizedSelected[normalizedSelected.length - remainingChars] === ' ') {
                            remainingChars--;
                        }
                    } else {
                        originalIndex++;
                        remainingChars--;
                    }
                }
                
                selectedText = {
                    columnIndex: targetColumnIndex,
                    panelIndex: targetPanelIndex,
                    text: selectedString,
                    startIndex: startIndex,
                    endIndex: originalIndex
                };
                console.log('Whitespace normalized selection:', selectedText);
                showSelectionFeedback();
                return;
            }
            
            console.log('Failed to find text in original argument');
            console.log('Selected:', `"${selectedString}"`);
            console.log('Original:', `"${originalText}"`);
        }

        function showSelectionFeedback() {
            // Create a temporary visual indicator
            const feedback = document.createElement('div');
            feedback.innerHTML = `✓ Selected: "${selectedText.text}"`;
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
                z-index: 1000;
                font-size: 14px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 2000);
        }

        function populateColumnOptions() {
            const select = document.getElementById('argumentColumn');
            select.innerHTML = '';
            
            data.forEach((_, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Column ${index + 1}`;
                select.appendChild(option);
            });
        }

        function showArgumentModal() {
            document.getElementById('argumentModal').style.display = 'block';
            document.getElementById('argumentError').innerHTML = '';
        }

        function showCritiqueModal() {
            if (!selectedText) {
                alert('Please select text from an argument first to add a critique.');
                return;
            }

            document.getElementById('critiqueModal').style.display = 'block';
            document.getElementById('critiqueError').innerHTML = '';
            
            const selectionInfo = document.getElementById('selectionInfo');
            selectionInfo.style.display = 'block';
            selectionInfo.innerHTML = `Selected text: "${selectedText.text}" (Column ${selectedText.columnIndex + 1}, Panel ${selectedText.panelIndex + 1})`;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function closeCritiqueModal() {
            document.getElementById('critiqueModal').style.display = 'none';
            document.getElementById('selectionInfo').style.display = 'none';
            // Clear selection
            window.getSelection().removeAllRanges();
            selectedText = null;
        }

        async function submitArgument(event) {
            event.preventDefault();
            
            const columnIndex = parseInt(document.getElementById('argumentColumn').value);
            const argumentText = document.getElementById('argumentText').value.trim();
            
            try {
                const response = await fetch(`${API_BASE}/argument`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        column_index: columnIndex,
                        argument: argumentText
                    })
                });

                if (response.ok) {
                    closeModal('argumentModal');
                    document.getElementById('argumentText').value = '';
                    await loadData();
                } else {
                    const error = await response.json();
                    document.getElementById('argumentError').innerHTML = `<div class="error">${error.detail}</div>`;
                }
            } catch (error) {
                console.error('Error submitting argument:', error);
                document.getElementById('argumentError').innerHTML = '<div class="error">Network error. Please try again.</div>';
            }
        }

        async function submitCritique(event) {
            event.preventDefault();
            
            if (!selectedText) {
                document.getElementById('critiqueError').innerHTML = '<div class="error">No text selected</div>';
                return;
            }
            
            const critiqueText = document.getElementById('critiqueText').value.trim();
            
            try {
                const response = await fetch(`${API_BASE}/critique`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        column_index: selectedText.columnIndex,
                        panel_index: selectedText.panelIndex,
                        critique_text: critiqueText,
                        start_ind: selectedText.startIndex,
                        end_ind: selectedText.endIndex
                    })
                });

                if (response.ok) {
                    closeCritiqueModal();
                    document.getElementById('critiqueText').value = '';
                    await loadData();
                } else {
                    const error = await response.json();
                    document.getElementById('critiqueError').innerHTML = `<div class="error">${error.detail}</div>`;
                }
            } catch (error) {
                console.error('Error submitting critique:', error);
                document.getElementById('critiqueError').innerHTML = '<div class="error">Network error. Please try again.</div>';
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const argumentModal = document.getElementById('argumentModal');
            const critiqueModal = document.getElementById('critiqueModal');
            
            if (event.target === argumentModal) {
                closeModal('argumentModal');
            }
            if (event.target === critiqueModal) {
                closeCritiqueModal();
            }
        }
    </script>
</body>
</html>
