<body>
  <h1>Deliberator App</h1>

  <div id="text-container"></div>

  <textarea id="critiqueInput" placeholder="Enter your critique here..."></textarea>
  <button onclick="submitCritique()">Submit Critique</button>

  <script>
    async function fetchData(url, options = {}) {
      const res = await fetch(url, options);
      return res.json();
    }

    function getSelectedTextInfo() {
      const selection = window.getSelection();
      if (!selection || selection.isCollapsed) return null;

      const range = selection.getRangeAt(0);
      const container = document.getElementById("text-container");

      if (!container.contains(range.commonAncestorContainer)) return null;

      return {
        text: selection.toString(),
        start: range.startOffset,
        end: range.endOffset
      };
    }

    async function submitCritique() {
      const selectionInfo = getSelectedTextInfo();
      const critiqueText = document.getElementById("critiqueInput").value;

      if (!selectionInfo) {
        alert("Highlight some argument text first.");
        return;
      }

      if (!critiqueText.trim()) {
        alert("Enter a critique before submitting.");
        return;
      }

      const payload = {
        text: selectionInfo.text,
        start: selectionInfo.start,
        end: selectionInfo.end,
        critique: critiqueText
      };

      console.log("Sending critique:", payload);

      try {
        const response = await fetchData("https://deliberator-app.onrender.com/highlight", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        console.log("Backend response:", response);
        alert("Critique submitted!");
        document.getElementById("critiqueInput").value = "";
        await renderData(); // refresh display
      } catch (err) {
        console.error("Error sending critique:", err);
      }
    }

    async function renderData() {
      const data = await fetchData("https://deliberator-app.onrender.com/data");

      const container = document.getElementById("text-container");
      container.innerHTML = "";

      data.forEach((column, colIdx) => {
        const colDiv = document.createElement("div");
        colDiv.style.display = "inline-block";
        colDiv.style.margin = "1em";

        column.forEach((panel, panelIdx) => {
          const panelDiv = document.createElement("div");
          panelDiv.style.border = "1px solid #ccc";
          panelDiv.style.padding = "0.5em";
          panelDiv.style.marginBottom = "1em";
          panelDiv.style.width = "300px";

          const argSpan = document.createElement("span");
          argSpan.textContent = panel.argument;
          argSpan.style.display = "block";
          argSpan.style.whiteSpace = "pre-wrap";

          const critiquesDiv = document.createElement("div");
          critiquesDiv.style.maxHeight = "150px";
          critiquesDiv.style.overflowY = "auto";
          critiquesDiv.style.borderTop = "1px dashed #aaa";
          critiquesDiv.style.marginTop = "0.5em";
          critiquesDiv.style.paddingTop = "0.5em";

          panel.critiques.forEach(([crit, start, end]) => {
            const critElem = document.createElement("div");
            critElem.textContent = crit;

            critElem.addEventListener("mouseover", () => {
              highlightRange(argSpan, start, end, "yellow");
            });

            critElem.addEventListener("mouseout", () => {
              clearHighlights(argSpan);
            });

            critiquesDiv.appendChild(critElem);
          });

          panelDiv.appendChild(argSpan);
          panelDiv.appendChild(critiquesDiv);
          colDiv.appendChild(panelDiv);
        });

        container.appendChild(colDiv);
      });
    }

    function highlightRange(element, start, end, color) {
      const text = element.textContent;
      const before = text.slice(0, start);
      const highlight = text.slice(start, end);
      const after = text.slice(end);

      element.innerHTML = `${before}<span style="background-color:${color}">${highlight}</span>${after}`;
    }

    function clearHighlights(element) {
      element.innerHTML = element.textContent;
    }

    renderData();
  </script>
</body>
