<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Argument & Critiques</title>
  <style>
    body {
      display: flex;
      gap: 20px;
      padding: 20px;
      font-family: sans-serif;
    }
    .column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .panel {
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      padding: 10px;
      gap: 10px;
    }
    .argument, .critiques {
      width: 300px;
      overflow-y: auto;
      max-height: 200px;
      padding: 5px;
      border: 1px solid #eee;
    }
    .highlight {
      background-color: yellow;
    }
    .critique-item:hover {
      background-color: #ffeaa7;
      cursor: pointer;
    }
    .form {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
  </style>
</head>
<body>
  <script>
    const backendURL = "https://deliberator-app.onrender.com";

    async function fetchData(endpoint) {
      try {
        const res = await fetch(`${backendURL}${endpoint}`);
        if (!res.ok) throw new Error("Failed to fetch");
        return await res.json();
      } catch (err) {
        console.error("Fetch error:", err);
        return null;
      }
    }

    function createPanel(panelData, panelId, columnIndex) {
      const panel = document.createElement('div');
      panel.className = 'panel';

      const argDiv = document.createElement('div');
      argDiv.className = 'argument';
      const rawArg = panelData.argument;
      const spanMap = {};
      let selectedStart = null;
      let selectedEnd = null;

      for (let i = 0; i < rawArg.length; i++) {
        const span = document.createElement('span');
        span.textContent = rawArg[i];
        span.dataset.index = i;
        argDiv.appendChild(span);
        spanMap[i] = span;
      }

      const critDiv = document.createElement('div');
      critDiv.className = 'critiques';

      panelData.critiques.forEach(([text, start, end], idx) => {
        const item = document.createElement('div');
        item.className = 'critique-item';
        item.textContent = text;

        item.addEventListener('mouseenter', () => {
          for (let i = start; i < end; i++) {
            spanMap[i]?.classList.add('highlight');
          }
        });

        item.addEventListener('mouseleave', () => {
          for (let i = start; i < end; i++) {
            spanMap[i]?.classList.remove('highlight');
          }
        });

        critDiv.appendChild(item);
      });

      Object.keys(spanMap).forEach(i => {
        const span = spanMap[i];
        span.addEventListener('mouseenter', () => {
          panelData.critiques.forEach(([text, start, end], idx) => {
            if (i >= start && i < end) {
              critDiv.children[idx]?.classList.add('highlight');
            }
          });
        });
        span.addEventListener('mouseleave', () => {
          panelData.critiques.forEach(([text, start, end], idx) => {
            if (i >= start && i < end) {
              critDiv.children[idx]?.classList.remove('highlight');
            }
          });
        });
      });

      // Capture highlight selection
      argDiv.addEventListener('mouseup', () => {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        if (!argDiv.contains(range.startContainer) || !argDiv.contains(range.endContainer)) return;

        let startIndex = parseInt(range.startContainer.parentElement?.dataset.index);
        let endIndex = parseInt(range.endContainer.parentElement?.dataset.index) + 1;

        if (!isNaN(startIndex) && !isNaN(endIndex)) {
          selectedStart = startIndex;
          selectedEnd = endIndex;
        }
      });

      // Critique form
      const form = document.createElement('div');
      form.className = 'form';

      const textarea = document.createElement('textarea');
      textarea.rows = 2;
      textarea.placeholder = "Enter critique...";

      const submit = document.createElement('button');
      submit.textContent = "Submit Critique";
      submit.onclick = async () => {
        const critiqueText = textarea.value.trim();
        if (!critiqueText || selectedStart === null || selectedEnd === null) {
          alert("Please highlight some text in an argument and write a critique.");
          return;
        }

        const payload = {
          argument: rawArg,
          critique: critiqueText,
          start_ind: selectedStart,
          end_ind: selectedEnd,
          author: "demo_user"
        };

        try {
          const res = await fetch(`${backendURL}/critique`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          alert(result.message || "Critique submitted.");
          location.reload(); // Reload to show update
        } catch (err) {
          console.error(err);
          alert("Failed to submit critique.");
        }
      };

      form.appendChild(textarea);
      form.appendChild(submit);

      panel.appendChild(argDiv);
      panel.appendChild(critDiv);
      panel.appendChild(form);

      return panel;
    }

    async function renderData() {
      const data = await fetchData("/data");
      if (!data) return;

      data.forEach((col, colIdx) => {
        const columnEl = document.createElement('div');
        columnEl.className = 'column';

        col.forEach((panelData, panelIdx) => {
          const panel = createPanel(panelData, panelIdx, colIdx);
          columnEl.appendChild(panel);
        });

        document.body.appendChild(columnEl);
      });
    }

    renderData();
  </script>
</body>
</html>
